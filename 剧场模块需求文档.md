# 剧场模块需求文档

## 一、模块概述

### 1.1 模块名称
剧场（Theater）

### 1.2 模块描述
剧场模块是一个英文学习动画片播放系统，包含7集系列动画。用户需要通过观看动画并完成与AI玩偶的沟通任务来逐步解锁后续剧集，旨在通过交互式学习提升用户的英语能力和使用粘性。

### 1.3 设计目标
- 增强用户与玩偶的互动频次
- 通过解锁机制提升用户留存和活跃度
- 分阶段引导用户完成英语学习任务

---

## 二、功能需求

### 2.1 剧集列表展示

| 字段 | 说明 |
|------|------|
| 集数编号 | 1-7集 |
| 剧集标题 | 如"与星宝相识" |
| 任务描述 | 如"用英文做自我介绍，包含my,name,like等高频主题词" |
| 状态标识 | 已完成(绿色✓) / 可播放(橙色▶) / 已锁定(灰色🔒) |

### 2.2 剧集解锁规则

| 集数 | 解锁条件 |
|------|----------|
| **第1集** | 直接可观看，无需解锁 |
| **第2集** | ① 第1集已播放<br>② 与玩偶沟通满 **3轮次** |
| **第3集** | ① 第1、2集已播放<br>② 与玩偶沟通满 **5轮次** |
| **第4集** | ① 第3集已播放<br>② 与玩偶沟通满 **5轮次**<br>③ 距离第3集播放时间间隔 **24小时** |
| **第5集** | ① 第4集已播放<br>② 与玩偶沟通满 **5轮次**<br>③ 距离第4集播放时间间隔 **24小时** |
| **第6集** | ① 第5集已播放<br>② 与玩偶沟通满 **5轮次**<br>③ 距离第5集播放时间间隔 **24小时** |
| **第7集** | ① 第6集已播放<br>② 与玩偶沟通满 **5轮次**<br>③ 距离第6集播放时间间隔 **24小时** |

> **沟通轮次定义**：接收到用户向玩偶发送的一条语音消息，计为1轮次。

### 2.3 进度条展示规则

进度条仅显示在**下一个待解锁**的集数下方：

| 场景 | 进度条展示位置 | 展示内容 |
|------|---------------|----------|
| 第1集已播放，第2集待解锁 | 第2集下方 | 沟通进度 X/3轮次 |
| 第2集已播放，第3集待解锁 | 第3集下方 | 沟通进度 X/5轮次 |
| 第3集已播放，第4集待解锁 | 第4集下方 | 沟通进度 X/5轮次 + 24小时倒计时 |
| 第4-6集已播放，下一集待解锁 | 下一集下方 | 沟通进度 X/5轮次 + 24小时倒计时 |

**进度条状态说明：**
- 沟通轮次未满：显示 `X/N轮次`
- 沟通轮次已满：显示 `沟通进度完成`
- 24小时未满：显示 `⏰ 还需等待：X小时X分钟`
- 24小时已满：显示 `✓ 24小时间隔已完成`（绿色）

### 2.4 用户交互

#### 2.4.1 点击已解锁/可播放集数
- 跳转至视频播放页面 `video-player.html?episode={集数}`
- 自动标记该集为"已播放"
- 记录播放时间（用于24小时计时）

#### 2.4.2 点击已锁定集数
弹出解锁条件提示框，仅显示**未完成**的条件：

```
解锁第X集需要：
1. 播放第X集
2. 与玩偶沟通X轮次（当前：X/X）
3. 距离播放第X集间隔24小时（还需等待：X小时X分钟）
```

#### 2.4.3 底部导航栏
| 导航项 | 跳转页面 | 状态 |
|--------|----------|------|
| 伙伴 | pairing-set.html | 默认 |
| 剧场 | 当前页面 | 高亮 |
| 成长 | growth.html | 默认 |
| 我的 | mine.html | 默认 |

---

<!-- ## 三、数据存储

### 3.1 本地存储字段（localStorage）

| Key | 类型 | 说明 |
|-----|------|------|
| `theaterDemoPlayedEpisodes` | Array&lt;number&gt; | 已播放的集数列表，如 [1, 2, 3] |
| `theaterDemoUnlockedEpisodes` | Array&lt;number&gt; | 已解锁的集数列表 |
| `theaterDemoCommunicationRounds` | number | 当前累计沟通轮次 |
| `theaterDemoCompleteTimes` | Object | 每集播放完成时间戳，如 {"1": 1705123456789, "2": 1705209856789} |

### 3.2 沟通轮次重置规则

当满足某集解锁条件后：
- 该集加入 `unlockedEpisodes`
- `communicationRounds` 重置为 **0**
- 开始累计下一集的沟通轮次

---

## 四、接口需求（后端对接）

### 4.1 获取沟通轮次
```
接口：GET /api/communication/rounds
返回：{ rounds: number }
说明：获取用户与玩偶的沟通轮次（由后端统计用户发送的语音消息数量）
```

### 4.2 获取剧集状态
```
接口：GET /api/theater/episodes
返回：{
  playedEpisodes: number[],
  unlockedEpisodes: number[],
  episodeCompleteTimes: { [episodeId: string]: number }
}
```

### 4.3 记录剧集播放
```
接口：POST /api/theater/play
参数：{ episodeId: number }
说明：用户点击播放时调用，记录播放时间
```

---

## 五、UI设计规范

### 5.1 集数卡片样式

| 状态 | 左边框颜色 | 数字背景色 | 图标 | 透明度 |
|------|-----------|-----------|------|--------|
| 已完成 | #4CAF50 (绿色) | #4CAF50 | ✓ | 100% |
| 可播放 | #FF8C42 (橙色) | 渐变橙色 | ▶ | 100% |
| 已锁定 | 无 | #E0E0E0 (灰色) | 🔒 | 60% |

### 5.2 进度条样式
- 背景色：#E5E5E5
- 填充色：渐变 #FF8C42 → #FFA366
- 高度：6px
- 圆角：3px

### 5.3 页面整体配色
- 背景：渐变 #FFF4E6 → #FFF8F0
- 主题色：#FF8C42（橙色）
- 成功色：#4CAF50（绿色）
- 文字色：#333（主）/ #666（次）/ #999（辅助）

--- -->

## 三、异常处理

### 3.1 数据异常

| 场景 | 处理方式 |
|------|----------|
| 本地存储读取失败 | 返回默认空状态，不影响页面展示 |
| 数据格式错误/损坏 | 清除异常数据，重置为初始状态 |
| 沟通轮次与解锁状态不一致 | 以服务端数据为准，重新同步本地状态 |

### 3.2 网络异常

| 场景 | 处理方式 |
|------|----------|
| 网络断开 | 显示"网络连接失败，请检查网络设置"提示，使用本地缓存数据展示 |
| 接口请求超时 | 重试3次，仍失败则提示"加载失败，请稍后重试" |
| 接口返回错误 | 根据错误码显示对应提示信息 |

### 3.3 视频播放异常

| 场景 | 处理方式 |
|------|----------|
| 视频资源加载失败 | 显示"视频加载失败，请检查网络后重试"，提供重试按钮 |
| 视频播放中断 | 自动保存播放进度，下次进入时从断点续播 |
| 视频格式不支持 | 显示"当前设备不支持该视频格式"提示 |

### 3.4 状态异常

| 场景 | 处理方式 |
|------|----------|
| 页面切换后返回 | 监听 `visibilitychange` 事件，重新加载状态并刷新页面 |
| 未绑定设备 | 显示睡眠状态提示"请先绑定设备" |
| 多端登录数据冲突 | 以最新操作时间的数据为准，提示用户"数据已同步" |
| 用户修改系统时间 | 24小时计时以服务端时间为准，防止用户通过修改时间绕过限制 |

### 3.5 边界情况

| 场景 | 处理方式 |
|------|----------|
| 集数参数非法（如 episode=0 或 episode=99） | 提示"未找到该集数"，跳转回剧场列表页 |
| 直接访问未解锁集数的播放页 | 提示"该集数尚未解锁"，跳转回剧场列表页 |
| 所有集数已完成 | 显示"恭喜完成全部剧集"，引导用户回顾或分享 |

---

## 四、演示功能（仅开发/演示环境）

| 快捷键 | 功能 |
|--------|------|
| **C** | 增加1轮沟通轮次 |
| **D** | 增加24小时（所有已播放集数的完成时间前推24小时） |
| **重置演示按钮** | 清除所有本地存储数据，恢复初始状态 |

> ⚠️ 注：上线前需移除演示功能相关代码

---

## 五、版本记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | 2026-01-20 | 初始版本，包含7集解锁规则、进度条展示、24小时限制 |

---

**文档编写人**：AI Assistant  
**最后更新**：2026年1月20日
